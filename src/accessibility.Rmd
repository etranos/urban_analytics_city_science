---
title: "Accessibility in practice"
author: Emmanouil Tranos
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
editor: source
bibliography: references.bib
---

## Setup

```{r setup, include=TRUE, results= 'hide', message=FALSE, warning=FALSE}
library(tidyverse)
library(accessibility)
library(sf)
#library(kableExtra)
#library(data.table)
```

## Aims of the practical

The aim of this practical is to calculate different accessibility indicators.
For a brief overview about accessibility, please have a look at [@rodrigue2020geography]
(for example [here](https://transportgeography.org/contents/methods/transportation-accessibility/)
and).
For a review have a look @HOLL2007286, @el2022making and @shi2020literature
as well as some older and well cited papers such as @geurs2004accessibility and 
@bruinsma1998accessibility. The below typology of accessibility concepts is from
@HOLL2007286.

1.  Network access

    -   distance to access the network

    -   travel opportunities

2.  Travel cost measures

    -   network access + distance/time travelled on the network

3.  Market potential accessibility

    -   destinations at greater distance provide diminishing opportunities

    -   $Acc_i = \sum_j\frac{W_j} {c_{ij}^a}$

Among other `R` packages, the practical is based on the `accessibility` package.
Some of the below materials are based on the package's [vignette](https://cran.r-project.org/web/packages/accessibility/vignettes/accessibility.html).

Let's start with using the toy data that comes with the `accessibility` package.
As you can see below, the data comes in `R`'s native data format called [`Rds`](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/readRDS)
and, therefore, we use the relevant function to read it -- `readRDS()`.

The first data object we are using is the travel time matrix between all potential
origins and destinations in city of Belo Horizonte, Brazil. 
As you can see, the matrix is stored in a *long format* and not as an $n*n$ matrix. 
If you check the dimension of that object you will understand what I mean
(`dim(travel_matrix)`).

```{r}
data_dir <- system.file("extdata", package = "accessibility")

travel_matrix <- readRDS(file.path(data_dir, "travel_matrix.rds")) 

head(travel_matrix)
```

Then, we are loading the characteristics of each location. As you can see, the 
`id` records match with the `from_id` and `to_id` from the `travel_matrix`.

```{r}
land_use_data <- readRDS(file.path(data_dir, "land_use_data.rds"))
head(land_use_data)
```

The first accessibility function we are using is `cost_to_closest()`. As per its
name, it calculates the minimum travel cost to the closest *n* number of opportunities.
In our example, as travel cost we understand the travel time between origins and 
destinations included in the column `travel_time` from the `travel_matrix` object. 
We are only interested in the closest (n=1) opportunity, which in this example is a school.

```{r}
mtc <- cost_to_closest(
  travel_matrix,
  land_use_data,
  opportunity = "schools",
  travel_cost = "travel_time",
  n = 1
)

head(mtc)
```

The next measure is the total number of opportunities (in other words cummulative
opportunities) within a cut-off of the travel cost. In other words, the below provides
the nu,ber of jobs accessibile within 30 minutes of travel time.

```{r}
cum_cutoff <- cumulative_cutoff(
  travel_matrix,
  land_use_data,
  opportunity = "jobs",
  travel_cost = "travel_time",
  cutoff = 30
)

head(cum_cutoff)
```

If the above was a form of *active* accessibility -- that is how many opportunities
one can access from their location -- the below offers a *passive* form of accessibility
-- that is how many individuals can be reached from each destination within a cuttof.
The latter is based on `travel_time` in the below. 

```{r}
passive_cum_cutoff <- cumulative_cutoff(
  travel_matrix,
  land_use_data,
  opportunity = "population",
  travel_cost = "travel_time",
  cutoff = 30,
  active = FALSE
)
head(passive_cum_cutoff)
```

Last, but not least we can calculate the gravity based accessibility indicators,
or, in other words, potential accessibility indicators. This is the same measure 
as the example we discussed during the class **ADD LINK**.
The intuition is that the furthest away each opportunity is, the less important
it becomes. So, the accessibility of a location $i$ is equal to the sum of all
opportunities available divided -- in other words discounted -- by the distance or 
the cost to reach them. The `negative_exp` function can take different decay functions
(see [here](https://cran.r-project.org/web/packages/accessibility/vignettes/decay_functions.html)).
We know from previous studies that the exponential function represents better shorter
interactions (e.g. within cities) while the power function works better for longer distance
interactions (e.g. migrations flows) [@fotheringham1989spatial, see also discussions
in @article{oshan2021spatial].

$Acc_{i} = \sum_j \frac{W_j}{d_{ij}^2}$


```{r}
negative_exp <- gravity(
  travel_matrix,
  land_use_data,
  opportunity = "schools",
  travel_cost = "travel_time",
  decay_function = decay_exponential(decay_value = 0.2)
)
head(negative_exp)
```

```{r}
grid <- system.file("extdata/grid_bho.rds", package = "accessibility")
grid <- readRDS(grid)

spatial_data <- merge(grid, cum_cutoff, by = "id")
#spatial_data <- merge(grid, negative_exp, by = "id")

ggplot() +
  geom_sf(data = spatial_data, aes(fill = jobs), color = NA) +
  labs(
    title = "Job accessibility by transit in under 30 min.",
    fill = "Accessible jobs"
  ) +
  scale_fill_viridis_c() +
  theme_void()
```
